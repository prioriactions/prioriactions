---
title: "Mitchell River"
output:
  rmarkdown::html_document:
    self_contained: yes
fontsize: 11pt
documentclass: article
vignette: >
  %\VignetteIndexEntry{Mitchell River}
  %\VignetteEngine{knitr::rmarkdown_notangle}
---

```{r setup, include = FALSE}
h <- 6
w <- 8
is_check <- ("CheckExEnv" %in% search()) || any(c("_R_CHECK_TIMINGS_",
             "_R_CHECK_LICENSE_") %in% names(Sys.getenv()))
knitr::opts_chunk$set(
  fig.align = "center", 
  eval = !is_check,
  collapse = TRUE,
  comment = "#>")
```

The Mitchell River is a river located in Far North Queensland, Australia. The river rises on the Atherton Tableland about 50 kilometres (31 mi) northwest of Cairns, and flows about 750 kilometres (470 mi) northwest across Cape York Peninsula from Mareeba to the Gulf of Carpentaria. we will use this case study to present some functionalities of the ´prioriactions´ package.

We started loading libraries:

```{r eval=FALSE, message=FALSE, warning=FALSE}
library(prioritizr) #To use the simulate features distribution
library(prioriactions)
library(raster) #To plot of shapefiles
library(tmap) #To create cool maps
library(scales) #To standardize the value of amount
library(reshape2) #To use the melt function
library(sp) #To use the spplot function
library(viridis) #To use viridis pallete
```

# Preparing data inputs

We divided the whole catchment (71,630 km2 into 2316 sites (i.e., sub-catchments), each one included the portion of river length between two consecutive river connections. We considered four major threats to freshwater fish species in the catchment: water buffalo (Bubalis bubalis), cane toad (Bufo marinus), river flow alteration (caused by impoundments, channels for water extractions and levee banks) and grazing land use. Also, we used the modelled spatial distribution of 45 fish species in the Mitchell river catchment as our conservation features. The distribution of features and threats () will be simulated while the other input files a *prioriactions* will be loaded directly from the package as follows:

```{r, fig.show='hold'}
path <- system.file("extdata/input_big/", package = "prioriactions")

pu_data <- data.table::fread(paste0(path,"unitCost_Big.csv"), data.table = FALSE)
features_data <- data.table::fread(paste0(path,"target_Big.csv"), data.table = FALSE)
bound_data <- data.table::fread(paste0(path,"boundary_Big.csv"), data.table = FALSE)
sensitivity_data <- data.table::fread(paste0(path,"sensibility_Big.csv"), data.table = FALSE)
```

We load the shapefile of the case study also included as part of the package installation:

```{r echo=TRUE, warning=FALSE}
#reading shapefile
shp_mitchell = raster::shapefile(paste0(path,"Mitchell.shp"))

sp::spplot(shp_mitchell, zcol = "Shape_Area", names.attr = "Area",
      main = "Planning unit areas", col.regions = viridis::viridis(20))
```

To model the distribution of features and threats, we use the function *simulate_species* from *prioritizr* package. Due this simulation is performed on a raster object, we rasterize the shapefile (through the *rasterize* function of the *raster* library) and then vectorize it again with the *extract* function of the same library.

```{r}
#We set the seed to can replicate the same simulations
set.seed(1)

#We transform the shapefile to raster with a convenient resolution for simulation
ext <- raster::extent(shp_mitchell)
r <- raster::raster(ext, res = 1000) 
r <- raster::rasterize(shp_mitchell, r, field=1)

#Simulation of 45 features distribution
dist_features <- prioritizr::simulate_species(r, 45, model = 	RandomFields::RMgauss(scale = 40000))

#We project the simulated rasters to shapefile
rij_data <- raster::extract(dist_features, shp_mitchell, fun = mean)
colnames(rij_data) <- features_data$id
```

In this way we obtain spatially auto correlated features distributions. Thus, for example, the distribution of simulated feature 1 is:

```{r warning=FALSE}
shp_mitchell$specie_distribution <- rij_data[,1]

#Plot distribution with tmap library
tmap::tm_shape(shp_mitchell) +
  tmap::tm_fill("specie_distribution", pal = c("white", "seagreen")) +
  tmap::tm_borders(col="black", lwd = 0.5)

```

Instead, the distribution of simulated threat 1 is:

```{r warning=FALSE}
#Simulation of 4 threats distribution
dist_threats <- prioritizr::simulate_species(r, 4, model = 	RandomFields::RMgauss(scale = 40000))

#We project the simulated rasters to shapefile
threats_data <- raster::extract(dist_threats, shp_mitchell, fun = mean)
colnames(threats_data) <- 1:4

shp_mitchell$threat_distribution <- threats_data[,1]

#Plot distribution with tmap library
tmap::tm_shape(shp_mitchell) +
  tmap::tm_fill("threat_distribution", pal = c("white", "red4")) +
  tmap::tm_borders(col="black", lwd = 0.5)
```

## 1) Model with presence / absence of threats and features

For the first prioritization exercise, we transform the amount data to values 0 and 1 for both features distribution and threats. In the case of features, a threshold of 0.5 was set, that is, if the value of the amount is equal to or greater than 0.5, it is considered that the features is present at the site. Instead, a threat is considered present if it has any non-zero amount value.

```{r warning=FALSE}
#Modifying continuous to binary amount data of features
rij_data_binary <- ifelse(rij_data > 0.5, 1, 0)
shp_mitchell$feature_distribution <- rij_data_binary[,1]

#Modifying continuous to binary amount data of threats
threats_data_binary <- ifelse(threats_data > 0.0, 1, 0)

#Plot example of feature distribution with tmap library
tmap::tm_shape(shp_mitchell) +
  tmap::tm_fill("feature_distribution", pal = c("white", "seagreen"), labels = c("0", "1"), breaks = c(0,1,2)) +
  tmap::tm_borders(col="black", lwd = 0.5)
```

Then, we create the features and threat distribution inputs in the corresponding format that will be used by the *prioriactions* package. Also, we modify the *features_data* to set the target of each feature at 15%.

```{r}
#Feature distribution data-------------------------------------
#We get the extended matrix of distribution data for both cases, set the specific col names and we are left with only positive values
rij_data_binary_large <- reshape2::melt(rij_data_binary)
colnames(rij_data_binary_large) <- c("pu", "species", "amount")
rij_data_binary_large <- rij_data_binary_large[rij_data_binary_large$amount > 0, ]

#threat distribution data-------------------------------------
threats_data_binary_large <- reshape2::melt(threats_data_binary)
colnames(threats_data_binary_large) <- c("pu", "threats", "amount")
threats_data_binary_large <- threats_data_binary_large[threats_data_binary_large$amount > 0, ]
threats_data_binary_large$cost <- 1
threats_data_binary_large$status <- 0

#features data-------------------------------------
features_data$target <- colSums(rij_data_binary)*0.15

```

## Base model

The base model considers the prioritization of conservation actions using the presence / absence of features and threats. In addition, a target has been set for all features of 15% of their representatives in the basin. The model, for its part, does not consider spatial requirements to the actions (*blm* and *blm_actions* parameters equal to 0. Furthermore, there is no attempt to optimize that planning actions occur within the same planning units (i.e., the *curve* parameter is equal to 1). The solver was configured to stop when a gap of at least 5% is achieved (0% meaning that at least one of the optimal solutions has been found).
